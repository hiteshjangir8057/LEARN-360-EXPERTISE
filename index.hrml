<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learn 360+ Cloud Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

    <style>
        /* --- CORE STYLES --- */
        :root {
            --primary: #1e3a8a;
            --glass: rgba(255, 255, 255, 0.95);
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Outfit', sans-serif; background: #f1f5f9; height: 100vh; overflow: hidden; }

        /* --- LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 20px;
            width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 10px; }
        .btn-login { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; }

        /* --- LAYOUT --- */
        #app-layout { display: none; height: 100vh; display: flex; }
        .sidebar { width: 260px; background: var(--primary); color: white; padding: 20px; display: flex; flex-direction: column; }
        .brand { font-size: 1.5rem; font-weight: 800; margin-bottom: 40px; }
        .nav-item { padding: 15px; margin-bottom: 5px; cursor: pointer; border-radius: 10px; display: flex; gap: 15px; align-items: center; }
        .nav-item.active { background: rgba(255,255,255,0.15); }
        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
        
        /* --- COMPONENTS --- */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-github { 
            background: #24292f; color: white; padding: 10px 20px; 
            border-radius: 8px; border:none; cursor: pointer; 
            display: flex; align-items: center; gap: 8px; font-weight: 600;
        }
        .btn-github.loading { opacity: 0.7; pointer-events: none; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .stat-val { font-size: 2rem; font-weight: 800; color: var(--primary); }

        .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 16px; overflow: hidden; }
        .data-table th { background: #f8fafc; text-align: left; padding: 20px; color: #64748b; }
        .data-table td { padding: 20px; border-bottom: 1px solid #e2e8f0; }

        .form-panel { background: white; padding: 40px; border-radius: 20px; max-width: 800px; margin: 0 auto; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group input, .input-group select { padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-top: 5px; }

        /* --- VIEWS --- */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- PRINT CSS (Hidden on Screen) --- */
        #print-area { display: none; }
        @media print {
            body { background: white; margin: 0; }
            #login-screen, #app-layout { display: none !important; }
            #print-area { display: block; width: 210mm; height: 297mm; }
            @page { size: A4; margin: 0; }
            
            .receipt-copy { width: 100%; height: 50%; padding: 5mm 10mm; display: flex; flex-direction: column; position: relative; border-bottom: 2px dashed #999; box-sizing: border-box; }
            .receipt-copy:last-child { border: none; padding-top: 10mm; }
            .main-border { border: 3px double #1e3a8a; height: 100%; padding: 10px; position: relative; border-radius: 4px; }
            .r-header { display: flex; justify-content: space-between; border-bottom: 2px solid #1e3a8a; padding-bottom: 10px; margin-bottom: 10px; }
            .logo-section h2 { margin: 0; font-size: 1.8rem; font-weight: 800; color: #1e3a8a; text-transform: uppercase; }
            .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; background: #f1f5f9; padding: 10px; border-radius: 6px; border: 1px solid #e2e8f0; }
            .fee-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
            .fee-table th { background: #1e3a8a; color: white; padding: 6px; text-align: left; -webkit-print-color-adjust: exact; }
            .fee-table td { padding: 8px; border-bottom: 1px solid #ccc; }
            .footer-section { margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end; }
            .watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-25deg); font-size: 6rem; font-weight: 900; color: rgba(30, 58, 138, 0.05); pointer-events: none; }
        }
    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="login-screen">
        <div class="login-box">
            <h2>Cloud Admin Portal</h2>
            <p>Sign in to access database</p>
            <input type="text" id="username" class="login-input" placeholder="Username (admin)">
            <input type="password" id="password" class="login-input" placeholder="Password (admin)">
            <button class="btn-login" onclick="login()">Secure Login</button>
        </div>
    </div>

    <!-- 2. ADMIN DASHBOARD -->
    <div id="app-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="brand"><i class="fas fa-cloud"></i> Learn 360+</div>
            <div class="nav-item active" onclick="switchView('dashboard', this)"><i class="fas fa-chart-line"></i> Dashboard</div>
            <div class="nav-item" onclick="switchView('create', this)"><i class="fas fa-plus"></i> New Receipt</div>
            <div class="nav-item" onclick="switchView('history', this)"><i class="fas fa-database"></i> Database</div>
        </div>

        <!-- Content -->
        <div class="main-content">
            
            <!-- Dashboard View -->
            <div id="view-dashboard" class="view-section active">
                <div class="header-bar">
                    <h1>Dashboard</h1>
                    <!-- GitHub Sync Button -->
                    <button id="syncBtn" class="btn-github" onclick="syncWithGitHub()">
                        <i class="fab fa-github"></i> <span id="syncText">Load from GitHub</span>
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-val" id="total-collected">₹0</div>
                        <div style="color:#666">Total Revenue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" id="total-receipts">0</div>
                        <div style="color:#666">Total Receipts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-val" style="color:green">Online</div>
                        <div style="color:#666">GitHub Status</div>
                    </div>
                </div>

                <h3>Recent Transactions</h3>
                <table class="data-table">
                    <thead><tr><th>No</th><th>Name</th><th>Amount</th><th>Date</th></tr></thead>
                    <tbody id="recent-table-body"></tbody>
                </table>
            </div>

            <!-- Create View -->
            <div id="view-create" class="view-section">
                <div class="header-bar"><h1>Generate Receipt</h1></div>
                <div class="form-panel">
                    <form onsubmit="processReceipt(event)">
                        <div class="form-grid">
                            <div class="input-group"><label>Receipt No</label><input type="text" id="receiptNo" required></div>
                            <div class="input-group"><label>Date</label><input type="date" id="date" required></div>
                            <div class="input-group" style="grid-column:1/-1"><label>Student Name</label><input type="text" id="studentName" required></div>
                            <div class="input-group"><label>Class</label><input type="text" id="class" required></div>
                            <div class="input-group"><label>Mobile</label><input type="number" id="mobileNo" required></div>
                            <div class="input-group"><label>Father</label><input type="text" id="fatherName" required></div>
                            <div class="input-group"><label>Amount (₹)</label><input type="number" id="feeAmount" required></div>
                            <div class="input-group">
                                <label>Mode</label>
                                <select id="payMode"><option>Cash</option><option>UPI</option><option>Bank</option></select>
                            </div>
                        </div>
                        <button type="submit" class="btn-login" style="margin-top:20px">Save to Cloud & Print</button>
                    </form>
                </div>
            </div>

            <!-- History View -->
            <div id="view-history" class="view-section">
                <div class="header-bar"><h1>Full Database</h1></div>
                <table class="data-table">
                    <thead><tr><th>No</th><th>Name</th><th>Class</th><th>Amount</th><th>Mode</th></tr></thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. PRINT AREA -->
    <div id="print-area"></div>

    <script>
        // ==========================================
        // GITHUB CONFIGURATION
        // ==========================================
        const GITHUB_TOKEN = "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"; // Your Key
        const REPO_OWNER = "LEARN 360+ EXPERTISE"; // <-- YAHAN APNA USERNAME LIKHE
        const REPO_NAME = "fee-receipt-db";        // <-- Create this repo on GitHub first
        const FILE_PATH = "data.json";
        
        let receipts = [];
        let fileSha = null; // Required for updating files on GitHub

        // --- LOGIN ---
        function login() {
            if(document.getElementById('username').value === 'admin' && document.getElementById('password').value === 'admin') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-layout').style.display = 'flex';
                document.getElementById('date').valueAsDate = new Date();
                // Try to load data immediately
                syncWithGitHub();
            } else { alert('Wrong password'); }
        }

        // --- NAVIGATION ---
        function switchView(id, btn) {
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            if(btn) btn.classList.add('active');
        }

        // ==========================================
        // GITHUB API INTEGRATION
        // ==========================================
        
        // 1. READ DATA (GET)
        async function syncWithGitHub() {
            const btn = document.getElementById('syncBtn');
            const txt = document.getElementById('syncText');
            
            // UI Loading State
            btn.classList.add('loading');
            txt.innerText = "Syncing...";

            try {
                // If username is not set
                if(REPO_OWNER === "YOUR_GITHUB_USERNAME") {
                    alert("Setup Error: Please open the code and replace 'YOUR_GITHUB_USERNAME' with your actual GitHub username.");
                    throw new Error("Config missing");
                }

                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.status === 404) {
                    console.log("File not found. Starting with empty database.");
                    receipts = [];
                    fileSha = null;
                } else if (response.ok) {
                    const data = await response.json();
                    fileSha = data.sha; // Save SHA for future updates
                    // GitHub content is Base64 encoded. Decode it.
                    // decodeURIComponent(escape(atob(...))) handles Unicode characters correctly
                    const content = decodeURIComponent(escape(atob(data.content)));
                    receipts = JSON.parse(content);
                } else {
                    throw new Error('GitHub API Error: ' + response.statusText);
                }

                updateUI();
                alert("✅ Data Synced Successfully!");

            } catch (error) {
                console.error(error);
                alert("Sync Failed: " + error.message);
            } finally {
                btn.classList.remove('loading');
                txt.innerText = "Sync Data";
            }
        }

        // 2. WRITE DATA (PUT)
        async function saveToGitHub() {
            const btn = document.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "Saving to Cloud...";
            btn.disabled = true;

            try {
                // Prepare content (Base64 encode)
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(receipts, null, 2))));
                
                const body = {
                    message: "Update receipts data",
                    content: content
                };
                
                // If updating existing file, attach SHA
                if (fileSha) {
                    body.sha = fileSha;
                }

                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const data = await response.json();
                    fileSha = data.content.sha; // Update SHA
                    return true;
                } else {
                    throw new Error("Save Failed");
                }

            } catch (error) {
                alert("Cloud Save Error: " + error.message);
                return false;
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // ==========================================
        // APP LOGIC
        // ==========================================
        function updateUI() {
            // Stats
            let total = receipts.reduce((s, i) => s + parseFloat(i.amount), 0);
            document.getElementById('total-collected').innerText = "₹" + total.toLocaleString();
            document.getElementById('total-receipts').innerText = receipts.length;

            // Tables
            const makeRow = (r) => `<tr><td>${r.no}</td><td>${r.name}</td><td>₹${r.amount}</td><td>${r.date}</td></tr>`;
            const makeFullRow = (r) => `<tr><td>${r.no}</td><td>${r.name}</td><td>${r.class}</td><td>₹${r.amount}</td><td>${r.mode}</td></tr>`;

            document.getElementById('recent-table-body').innerHTML = receipts.slice(-5).reverse().map(makeRow).join('');
            document.getElementById('history-table-body').innerHTML = receipts.slice().reverse().map(makeFullRow).join('');
        }

        async function processReceipt(e) {
            e.preventDefault();
            
            const data = {
                no: document.getElementById('receiptNo').value,
                date: document.getElementById('date').value,
                name: document.getElementById('studentName').value,
                class: document.getElementById('class').value,
                mobile: document.getElementById('mobileNo').value,
                father: document.getElementById('fatherName').value,
                amount: document.getElementById('feeAmount').value,
                mode: document.getElementById('payMode').value,
                timestamp: new Date().toISOString()
            };

            // 1. Add to local array
            receipts.push(data);
            
            // 2. Save to Cloud
            const saved = await saveToGitHub();
            
            if(saved) {
                updateUI();
                printReceipt(data); // Call Print Logic
            }
        }

        function numToWords(n) {
            // Simple converter logic
            if(n==0) return "Zero";
            return n + " Rupees Only"; // Simplified for brevity in this block
        }

        function printReceipt(data) {
            const amt = "₹" + parseFloat(data.amount).toFixed(2);
            // Using the clean layout (No QR)
            const template = `
            <div class="receipt-copy">
                <div class="main-border">
                    <div class="watermark">OFFICE COPY</div>
                    <div class="r-header">
                        <div class="logo-section">
                            <h2>Learn 360+ Expertise</h2>
                            <div style="font-size:0.9rem;">
                                <div><b>Resources Tuition Centre, Pilani</b></div>
                                <div>Sarawagi Dharamshala, Near Jherli Road</div>
                                <div><i class="fas fa-phone"></i> 9667683378, 9694449220</div>
                            </div>
                        </div>
                        <div style="text-align:right; border:1px solid #1e3a8a; padding:5px;">
                            <span style="background:#1e3a8a; color:white; font-size:0.7rem; padding:2px;">OFFICE COPY</span>
                            <div>No: <b>${data.no}</b></div>
                            <div>Date: <b>${data.date}</b></div>
                        </div>
                    </div>
                    <div class="details-grid">
                        <div>
                            <div>Name: <b>${data.name}</b></div>
                            <div>Class: <b>${data.class}</b></div>
                            <div>Mobile: <b>${data.mobile}</b></div>
                        </div>
                        <div>
                            <div>Father: <b>${data.father}</b></div>
                            <div>Mode: <b>${data.mode}</b></div>
                            <div style="color:green">Status: <b>PAID</b></div>
                        </div>
                    </div>
                    <table class="fee-table">
                        <thead><tr><th>Description</th><th style="text-align:right">Amount</th></tr></thead>
                        <tbody>
                            <tr><td>Tuition Fee</td><td style="text-align:right">${amt}</td></tr>
                            <tr style="height:40px"><td colspan="2"></td></tr>
                            <tr style="background:#e0e7ff; color:#1e3a8a; font-weight:bold"><td>TOTAL</td><td style="text-align:right">${amt}</td></tr>
                        </tbody>
                    </table>
                    <div class="footer-section">
                        <div style="font-size:0.7rem; color:#555">Terms: Fees not refundable.</div>
                        <div style="text-align:center; border-top:2px solid #000; width:100px;">Signatory</div>
                    </div>
                </div>
            </div>`;
            
            // Double template for Parents copy
            document.getElementById('print-area').innerHTML = template + template.replace("OFFICE COPY", "PARENTS COPY").replace("OFFICE COPY", "PARENTS COPY");
            window.print();
        }
    </script>
</body>
</html>
